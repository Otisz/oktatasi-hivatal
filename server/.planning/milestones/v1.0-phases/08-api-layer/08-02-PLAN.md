---
phase: 08-api-layer
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - tests/Feature/Api/ApplicantScoreTest.php
autonomous: true
requirements: [TEST-09, TEST-10, TEST-11, TEST-12, TEST-13]

must_haves:
  truths:
    - "Applicant 1 scores 470 (370 base + 100 bonus) via GET /api/v1/applicants/{uuid}/score"
    - "Applicant 2 scores 476 (376 base + 100 bonus) via GET /api/v1/applicants/{uuid}/score"
    - "Applicant 3 returns 422 with Hungarian error message for missing global mandatory subjects"
    - "Applicant 4 returns 422 with Hungarian error message for magyar 15% below 20%"
    - "Unknown applicant UUID returns 404"
  artifacts:
    - path: "tests/Feature/Api/ApplicantScoreTest.php"
      provides: "Feature tests covering all 5 acceptance cases"
      contains: "assertSuccessful"
  key_links:
    - from: "tests/Feature/Api/ApplicantScoreTest.php"
      to: "/api/v1/applicants/{uuid}/score"
      via: "getJson() HTTP test helper"
      pattern: "getJson.*api/v1/applicants"
    - from: "tests/Feature/Api/ApplicantScoreTest.php"
      to: "database/seeders/DatabaseSeeder.php"
      via: "$this->seed() in beforeEach"
      pattern: "\\$this->seed\\(\\)"
---

<objective>
Write feature tests that prove all five acceptance cases work end-to-end through the HTTP layer.

Purpose: These are the final acceptance tests proving the entire system works: seeded data flows through the API, scoring service calculates correctly, and errors render with the correct HTTP status and Hungarian messages.

Output: One Pest feature test file with 5 test cases covering the full acceptance matrix.
</objective>

<execution_context>
@/Users/otisz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/otisz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-api-layer/08-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From app/Models/Applicant.php:
```php
public const string CASE_1_UUID = '0195a1b2-0000-7000-8000-000000000001';
public const string CASE_2_UUID = '0195a1b2-0000-7000-8000-000000000002';
public const string CASE_3_UUID = '0195a1b2-0000-7000-8000-000000000003';
public const string CASE_4_UUID = '0195a1b2-0000-7000-8000-000000000004';
```

From tests/Pest.php:
```php
pest()->extend(Tests\TestCase::class)
 // ->use(Illuminate\Foundation\Testing\RefreshDatabase::class)   // COMMENTED OUT
    ->in('Feature');
```
Note: RefreshDatabase is commented out globally — the feature test file MUST opt in with `uses(RefreshDatabase::class)`.

From app/Exceptions/MissingGlobalMandatorySubjectException.php:
```php
// message: 'nem lehetséges a pontszámítás a kötelező érettségi tárgyak hiánya miatt'
```

From app/Exceptions/FailedExamException.php:
```php
// message: "nem lehetséges a pontszámítás a {$subject->value} tárgyból elért 20% alatti eredmény miatt"
// For Case 4 (magyar nyelv és irodalom at 15%):
// 'nem lehetséges a pontszámítás a magyar nyelv és irodalom tárgyból elért 20% alatti eredmény miatt'
```

Expected acceptance results (from homework spec):
- Case 1 (ELTE IK): osszpontszam=470, alappont=370, tobbletpont=100
- Case 2 (ELTE IK): osszpontszam=476, alappont=376, tobbletpont=100
- Case 3 (ELTE IK): MissingGlobalMandatorySubjectException (no magyar/tortenelem)
- Case 4 (ELTE IK): FailedExamException (magyar 15% < 20%)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create feature test for all 5 acceptance cases</name>
  <files>tests/Feature/Api/ApplicantScoreTest.php</files>
  <action>
    Create `tests/Feature/Api/ApplicantScoreTest.php` using `php artisan make:test --pest Api/ApplicantScoreTest`.

    Then replace the generated content with a Pest feature test file containing:

    **File setup:**
    ```php
    declare(strict_types=1);

    use App\Models\Applicant;
    use Illuminate\Foundation\Testing\RefreshDatabase;

    uses(RefreshDatabase::class);

    beforeEach(function (): void {
        $this->seed();
    });
    ```
    - `uses(RefreshDatabase::class)` is REQUIRED because tests/Pest.php has it commented out
    - `$this->seed()` runs DatabaseSeeder which creates the 2 programmes and 4 applicants

    **Test 1 (TEST-09): Applicant 1 scores 470**
    ```php
    it('returns score 470 for applicant 1', function (): void {
        $this->getJson('/api/v1/applicants/' . Applicant::CASE_1_UUID . '/score')
            ->assertSuccessful()
            ->assertJson([
                'data' => [
                    'osszpontszam' => 470,
                    'alappont'     => 370,
                    'tobbletpont'  => 100,
                ],
            ]);
    });
    ```

    **Test 2 (TEST-10): Applicant 2 scores 476**
    ```php
    it('returns score 476 for applicant 2', function (): void {
        $this->getJson('/api/v1/applicants/' . Applicant::CASE_2_UUID . '/score')
            ->assertSuccessful()
            ->assertJson([
                'data' => [
                    'osszpontszam' => 476,
                    'alappont'     => 376,
                    'tobbletpont'  => 100,
                ],
            ]);
    });
    ```

    **Test 3 (TEST-11): Applicant 3 returns 422 (missing global mandatory)**
    ```php
    it('returns 422 for applicant 3 missing global mandatory subjects', function (): void {
        $this->getJson('/api/v1/applicants/' . Applicant::CASE_3_UUID . '/score')
            ->assertStatus(422)
            ->assertJson([
                'error' => 'nem lehetséges a pontszámítás a kötelező érettségi tárgyak hiánya miatt',
            ]);
    });
    ```
    - Use `assertStatus(422)` — no named alias exists for 422 in Laravel

    **Test 4 (TEST-12): Applicant 4 returns 422 (magyar 15% failed exam)**
    ```php
    it('returns 422 for applicant 4 with failed magyar exam', function (): void {
        $this->getJson('/api/v1/applicants/' . Applicant::CASE_4_UUID . '/score')
            ->assertStatus(422)
            ->assertJson([
                'error' => 'nem lehetséges a pontszámítás a magyar nyelv és irodalom tárgyból elért 20% alatti eredmény miatt',
            ]);
    });
    ```

    **Test 5 (TEST-13): Unknown applicant returns 404**
    ```php
    it('returns 404 for unknown applicant', function (): void {
        $this->getJson('/api/v1/applicants/00000000-0000-0000-0000-000000000000/score')
            ->assertNotFound();
    });
    ```
    - Use `assertNotFound()` per pest-testing skill convention (not `assertStatus(404)`)
    - UUID `00000000-0000-0000-0000-000000000000` is well-formed but will never match a seeded applicant

    Run `vendor/bin/pint --dirty --format agent` after creating the file.
  </action>
  <verify>
    <automated>php artisan test --compact tests/Feature/Api/ApplicantScoreTest.php</automated>
  </verify>
  <done>
    - All 5 tests pass: 2 success cases (470, 476), 2 error cases (422), 1 not-found case (404)
    - Test file uses RefreshDatabase + seed() for database isolation
    - Pint passes with no changes
    - Full test suite still passes: `php artisan test --compact`
  </done>
</task>

</tasks>

<verification>
1. `php artisan test --compact tests/Feature/Api/ApplicantScoreTest.php` — all 5 tests pass
2. `php artisan test --compact` — full suite passes (no regressions)
3. `vendor/bin/pint --dirty --format agent` — no formatting issues
</verification>

<success_criteria>
- TEST-09: Applicant 1 returns 200 with { data: { osszpontszam: 470, alappont: 370, tobbletpont: 100 } }
- TEST-10: Applicant 2 returns 200 with { data: { osszpontszam: 476, alappont: 376, tobbletpont: 100 } }
- TEST-11: Applicant 3 returns 422 with { error: 'nem lehetseges...' } for missing mandatory subjects
- TEST-12: Applicant 4 returns 422 with { error: 'nem lehetseges...' } for magyar 15% failed exam
- TEST-13: Unknown UUID returns 404
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/08-api-layer/08-02-SUMMARY.md`
</output>
