---
phase: 06-calculators
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/Services/BasePointCalculator.php
  - app/Services/BonusPointCalculator.php
  - tests/Unit/Services/BasePointCalculatorTest.php
  - tests/Unit/Services/BonusPointCalculatorTest.php
autonomous: true
requirements: [BIZ-03, BIZ-04, TEST-06, TEST-07]

must_haves:
  truths:
    - "BasePointCalculator returns (mandatory + bestElective) * 2 for typical inputs"
    - "BasePointCalculator caps result at 400"
    - "BonusPointCalculator adds 50 per emelt-level exam result"
    - "BonusPointCalculator deduplicates language certificates per language, keeping highest points"
    - "BonusPointCalculator caps total bonus at 100"
  artifacts:
    - path: "app/Services/BasePointCalculator.php"
      provides: "Base point calculation service"
      contains: "final class BasePointCalculator"
    - path: "app/Services/BonusPointCalculator.php"
      provides: "Bonus point calculation service"
      contains: "final class BonusPointCalculator"
    - path: "tests/Unit/Services/BasePointCalculatorTest.php"
      provides: "Unit tests for base point formula and boundaries"
      min_lines: 20
    - path: "tests/Unit/Services/BonusPointCalculatorTest.php"
      provides: "Unit tests for bonus points, dedup, and cap"
      min_lines: 40
  key_links:
    - from: "app/Services/BasePointCalculator.php"
      to: "app/ValueObjects/ExamResult.php"
      via: "ExamResult::points() method"
      pattern: "->points\\(\\)"
    - from: "app/Services/BonusPointCalculator.php"
      to: "app/ValueObjects/ExamResult.php"
      via: "ExamResult::isAdvancedLevel() method"
      pattern: "->isAdvancedLevel\\(\\)"
    - from: "app/Services/BonusPointCalculator.php"
      to: "app/ValueObjects/LanguageCertificate.php"
      via: "LanguageCertificate::points() and language() methods"
      pattern: "->language\\(\\)"
---

<objective>
Implement BasePointCalculator and BonusPointCalculator as pure stateless services with full unit test coverage.

Purpose: These two calculators encode the core admission scoring formulas. BasePointCalculator computes the base score from mandatory + best elective exam results. BonusPointCalculator accumulates emelt-level bonuses and language certificate points with per-language deduplication. Both are consumed by AdmissionScoringService in Phase 7.

Output: Two final service classes in app/Services/ and two Pest unit test files in tests/Unit/Services/.
</objective>

<execution_context>
@/Users/otisz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/otisz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-calculators/06-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->
<!-- Executor should use these directly — no codebase exploration needed. -->

From app/ValueObjects/ExamResult.php:
```php
final readonly class ExamResult
{
    public function __construct(
        public SubjectName $subject,
        public ExamLevel $level,
        public int $percentage,
    ) { /* validates 0-100, throws FailedExamException if < 20 */ }

    public function points(): int { return $this->percentage; }
    public function isAdvancedLevel(): bool { return ExamLevel::Advanced === $this->level; }
}
```

From app/ValueObjects/LanguageCertificate.php:
```php
final readonly class LanguageCertificate
{
    public function __construct(
        public LanguageCertificateType $type,
        public string $language,
    ) {}

    public function points(): int { return $this->type->points(); }
    public function language(): string { return $this->language; }
}
```

From app/Enums/LanguageCertificateType.php:
```php
// UpperIntermediate (B2) -> points() returns 28
// Advanced (C1) -> points() returns 40
```

From app/Enums/ExamLevel.php:
```php
enum ExamLevel: string
{
    case Intermediate = 'kozep';
    case Advanced = 'emelt';
}
```

From app/Enums/SubjectName.php:
```php
// Mathematics = 'matematika', Informatics = 'informatika', Physics = 'fizika', etc.
```

Test pattern (from tests/Unit/ValueObjects/ExamResultTest.php):
```php
it('description', function (int $param1, int $param2, int $expected): void {
    // arrange, act, assert with expect()
})->with([
    'label' => [val1, val2, expected],
]);
```
</interfaces>
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: TDD BasePointCalculator</name>
  <files>app/Services/BasePointCalculator.php, tests/Unit/Services/BasePointCalculatorTest.php</files>
  <behavior>
    - Test 1: typical inputs (90% mandatory + 95% elective) returns (90+95)*2 = 370
    - Test 2: maximum boundary (100% + 100%) returns 400 (not 400+)
    - Test 3: minimum valid inputs (20% + 20%) returns 80
    - Test 4: mixed percentages via dataset (50+50=200, 75+80=310, 100+90=380)
    - Test 5: boundary at cap — inputs that produce exactly 400 (100+100)
  </behavior>
  <action>
    RED: Create tests/Unit/Services/BasePointCalculatorTest.php with dataset-driven tests exercising the formula (mandatory->points() + bestElective->points()) * 2 and the 400 cap. Use ExamResult VOs directly (no mocks — they are pure). Use SubjectName::Mathematics for mandatory and SubjectName::Informatics for elective (arbitrary choices, calculator does not inspect subject names). Run tests — they must fail (class does not exist yet).

    GREEN: Create app/Services/BasePointCalculator.php as a `final class` (NOT `final readonly class` — no constructor properties to promote). Single method: `public function calculate(ExamResult $mandatory, ExamResult $bestElective): int`. Implementation: `return min(($mandatory->points() + $bestElective->points()) * 2, 400);`. Add `declare(strict_types=1)` at top. Run tests — all must pass.

    Run `vendor/bin/pint --dirty --format agent` after creating PHP files.

    IMPORTANT: Do NOT use `readonly` on this class. It has no promoted constructor properties. Use `final` only per research guidance.
  </action>
  <verify>
    <automated>cd /Users/otisz/Projects/oktatasi-hivatal/server && php artisan test --compact --filter=BasePointCalculator</automated>
  </verify>
  <done>BasePointCalculator exists with calculate() method. All boundary tests pass: (90+95)*2=370, (100+100)*2=400 capped, (20+20)*2=80. Pint clean.</done>
</task>

<task type="auto" tdd="true">
  <name>Task 2: TDD BonusPointCalculator</name>
  <files>app/Services/BonusPointCalculator.php, tests/Unit/Services/BonusPointCalculatorTest.php</files>
  <behavior>
    - Test 1: single emelt exam result returns 50
    - Test 2: two emelt exam results return 100
    - Test 3: no emelt exams, no certs returns 0
    - Test 4: single B2 certificate returns 28
    - Test 5: single C1 certificate returns 40
    - Test 6: B2 + C1 same language — dedup keeps C1 only, returns 40
    - Test 7: B2 angol + C1 nemet — different languages, both count, returns 68
    - Test 8: one emelt (50) + B2 angol (28) + C1 nemet (40) = 118 -> capped at 100
    - Test 9: cap enforcement — raw total exceeds 100, returns exactly 100
    - Test 10: Applicant 1 scenario — 1 emelt (50) + B2 angol (28) + C1 nemet (40) = 118 -> 100
    - Test 11: intermediate-level exam results do not add bonus points
    - Test 12: empty arrays return 0
  </behavior>
  <action>
    RED: Create tests/Unit/Services/BonusPointCalculatorTest.php. Test the full matrix: emelt-only scenarios, cert-only scenarios, mixed scenarios, dedup same-language certs, and the 100 cap. Construct ExamResult and LanguageCertificate VOs directly. Use datasets where inputs share structure. Key test: B2 angol + C1 angol should return 40 (not 68) — dedup by language(), keep max points. Run tests — must fail.

    GREEN: Create app/Services/BonusPointCalculator.php as a `final class` (NOT `final readonly class`). Single method with PHPDoc array shapes:
    ```php
    /**
     * @param array<int, ExamResult> $examResults
     * @param array<int, LanguageCertificate> $certificates
     */
    public function calculate(array $examResults, array $certificates): int
    ```

    Implementation:
    1. Iterate $examResults — for each where isAdvancedLevel() is true, add 50.
    2. Build `array<string, int>` $langMap — iterate $certificates, key by language(), store max(existing, cert->points()).
    3. Sum $langMap values with array_sum().
    4. Return min($emeltPoints + $certPoints, 100).

    Add `declare(strict_types=1)` at top. Run tests — all must pass.

    Run `vendor/bin/pint --dirty --format agent` after creating PHP files.

    IMPORTANT: Dedup is by language (string), NOT by certificate type. Two C1 certs for different languages both count. Two certs (B2+C1) for same language — only the higher (C1=40) counts.
  </action>
  <verify>
    <automated>cd /Users/otisz/Projects/oktatasi-hivatal/server && php artisan test --compact --filter=BonusPointCalculator</automated>
  </verify>
  <done>BonusPointCalculator exists with calculate() method. All tests pass: emelt +50 each, same-language dedup keeps max, B2+C1 same lang = 40 not 68, total capped at 100. Pint clean.</done>
</task>

</tasks>

<verification>
Run all unit tests to confirm no regressions:
```bash
cd /Users/otisz/Projects/oktatasi-hivatal/server && php artisan test --compact tests/Unit/
```

Run Pint on all modified files:
```bash
cd /Users/otisz/Projects/oktatasi-hivatal/server && vendor/bin/pint --dirty --format agent
```

Verify both calculator files exist and are final classes:
```bash
grep -n "final class" app/Services/BasePointCalculator.php app/Services/BonusPointCalculator.php
```
</verification>

<success_criteria>
- BasePointCalculator::calculate(ExamResult, ExamResult) returns correct formula results for all boundary cases
- BonusPointCalculator::calculate(ExamResult[], LanguageCertificate[]) handles emelt counting, language dedup, and 100 cap
- All unit tests in tests/Unit/Services/BasePointCalculatorTest.php pass
- All unit tests in tests/Unit/Services/BonusPointCalculatorTest.php pass
- No regressions in existing test suite
- Pint formatting clean on all modified files
</success_criteria>

<output>
After completion, create `.planning/phases/06-calculators/06-01-SUMMARY.md`
</output>
