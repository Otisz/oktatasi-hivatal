---
phase: 02-value-objects
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - app/ValueObjects/ExamResult.php
  - tests/Unit/ValueObjects/ExamResultTest.php
autonomous: true
requirements:
  - DOM-04
  - TEST-01

must_haves:
  truths:
    - "ExamResult with percentage < 0 or > 100 throws InvalidArgumentException before any business rule check"
    - "ExamResult with percentage 0-19 throws FailedExamException (not InvalidArgumentException)"
    - "ExamResult with percentage 20-100 constructs successfully and stores subject, level, percentage as readonly properties"
    - "ExamResult::points() returns the percentage value unchanged"
    - "ExamResult::isAdvancedLevel() returns true only for ExamLevel::Advanced and false for ExamLevel::Intermediate"
    - "ExamResultTest passes with all boundary datasets covering -1, 0, 1, 19, 20, 50, 99, 100, 101"
  artifacts:
    - path: "app/ValueObjects/ExamResult.php"
      provides: "Immutable Value Object for exam results with two-stage constructor validation"
      contains: "readonly class ExamResult"
    - path: "tests/Unit/ValueObjects/ExamResultTest.php"
      provides: "Pest unit tests for ExamResult boundary values, exception paths, and computed methods"
      contains: "ExamResult"
  key_links:
    - from: "app/ValueObjects/ExamResult.php"
      to: "app/Enums/SubjectName.php"
      via: "use App\\Enums\\SubjectName in constructor parameter"
      pattern: "use App\\\\Enums\\\\SubjectName"
    - from: "app/ValueObjects/ExamResult.php"
      to: "app/Enums/ExamLevel.php"
      via: "use App\\Enums\\ExamLevel for isAdvancedLevel() comparison"
      pattern: "ExamLevel::Advanced"
    - from: "app/ValueObjects/ExamResult.php"
      to: "app/Exceptions/FailedExamException.php"
      via: "throws FailedExamException when percentage < 20"
      pattern: "throw new FailedExamException"
---

<objective>
Create the ExamResult Value Object with two-stage constructor validation and full Pest unit test coverage using TDD.

Purpose: ExamResult is the most complex VO in the domain — it enforces both range validation (0-100) and a business rule (< 20% = failed exam). The two-stage validation order is critical: range check MUST fire before business rule. TDD ensures this ordering is locked by tests before implementation.
Output: One readonly class in app/ValueObjects/ and one Pest unit test file in tests/Unit/ValueObjects/ with full boundary coverage.
</objective>

<execution_context>
@/Users/otisz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/otisz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-value-objects/02-CONTEXT.md
@.planning/phases/02-value-objects/02-RESEARCH.md
</context>

<interfaces>
<!-- Phase 1 enums and exceptions consumed by ExamResult -->

From app/Enums/SubjectName.php:
```php
enum SubjectName: string
{
    case HungarianLanguageAndLiterature = 'magyar nyelv és irodalom';
    case History = 'történelem';
    case Mathematics = 'matematika';
    // ... 10 more cases
}
```

From app/Enums/ExamLevel.php:
```php
enum ExamLevel: string
{
    case Intermediate = 'közép';
    case Advanced = 'emelt';
}
```

From app/Exceptions/FailedExamException.php:
```php
final class FailedExamException extends AdmissionException
{
    public function __construct(
        public readonly SubjectName $subject,
        public readonly int $percentage,
    ) {
        parent::__construct(
            "nem lehetséges a pontszámítás a {$subject->value} tárgyból elért 20% alatti eredmény miatt"
        );
    }
}
```
</interfaces>

<feature>
  <name>ExamResult Value Object with two-stage validation</name>
  <files>app/ValueObjects/ExamResult.php, tests/Unit/ValueObjects/ExamResultTest.php</files>
  <behavior>
    ExamResult is a PHP 8.2+ readonly class with three constructor-promoted public properties:
    - SubjectName $subject
    - ExamLevel $level
    - int $percentage

    Constructor validation (ORDER IS CRITICAL):
    1. If percentage < 0 or > 100 → throw \InvalidArgumentException
    2. If percentage < 20 → throw FailedExamException($subject, $percentage)

    Computed methods:
    - points(): int → returns $this->percentage
    - isAdvancedLevel(): bool → returns $this->level === ExamLevel::Advanced

    Test cases (boundary datasets):
    - Valid construction: 20, 50, 99, 100 → stores values correctly
    - InvalidArgumentException: -1, 101 → range guard fires
    - FailedExamException: 0, 1, 19 → business rule fires (NOT InvalidArgumentException)
    - points() returns percentage: 20, 75, 100
    - isAdvancedLevel(): Advanced → true, Intermediate → false
  </behavior>
  <implementation>
    RED: Create test file first with all datasets and assertions. Tests MUST fail (class doesn't exist yet).
    GREEN: Create ExamResult readonly class with two-stage validation. All tests pass.
    REFACTOR: Run Pint and PHPStan. Fix any issues.
  </implementation>
</feature>

<tasks>

<task type="auto">
  <name>Task 1: RED — Write failing ExamResultTest with full boundary datasets</name>
  <files>tests/Unit/ValueObjects/ExamResultTest.php</files>
  <action>
Create the test file using Artisan:
```bash
php artisan make:test --pest --unit --no-interaction ValueObjects/ExamResultTest
```

Replace the scaffolded content with the full test file. Use `declare(strict_types=1)` at the top.

Import these classes:
```php
use App\Enums\ExamLevel;
use App\Enums\SubjectName;
use App\Exceptions\FailedExamException;
use App\ValueObjects\ExamResult;
```

Write these test cases using inline Pest datasets:

**1. Valid construction — accepts valid percentages:**
```php
it('accepts valid percentages', function (int $percentage) {
    $result = new ExamResult(SubjectName::Mathematics, ExamLevel::Intermediate, $percentage);
    expect($result->percentage)->toBe($percentage);
})->with([20, 50, 99, 100]);
```

**2. Out-of-range guard — throws InvalidArgumentException:**
```php
it('throws InvalidArgumentException for out-of-range percentage', function (int $percentage) {
    expect(fn () => new ExamResult(SubjectName::Mathematics, ExamLevel::Intermediate, $percentage))
        ->toThrow(\InvalidArgumentException::class);
})->with([-1, 101]);
```

**3. Business rule guard — throws FailedExamException for < 20:**
```php
it('throws FailedExamException for percentage below 20', function (int $percentage) {
    expect(fn () => new ExamResult(SubjectName::Mathematics, ExamLevel::Intermediate, $percentage))
        ->toThrow(FailedExamException::class);
})->with([0, 1, 19]);
```

**4. points() accessor — returns percentage value:**
```php
it('returns percentage as points', function (int $percentage) {
    $result = new ExamResult(SubjectName::Mathematics, ExamLevel::Intermediate, $percentage);
    expect($result->points())->toBe($percentage);
})->with([20, 75, 100]);
```

**5. isAdvancedLevel() — detects level correctly:**
```php
it('detects advanced level correctly', function (ExamLevel $level, bool $expected) {
    $result = new ExamResult(SubjectName::Mathematics, $level, 50);
    expect($result->isAdvancedLevel())->toBe($expected);
})->with([
    'intermediate' => [ExamLevel::Intermediate, false],
    'advanced'     => [ExamLevel::Advanced, true],
]);
```

**6. Public properties are accessible:**
```php
it('exposes subject, level, and percentage as public properties', function () {
    $result = new ExamResult(SubjectName::Mathematics, ExamLevel::Advanced, 85);
    expect($result->subject)->toBe(SubjectName::Mathematics)
        ->and($result->level)->toBe(ExamLevel::Advanced)
        ->and($result->percentage)->toBe(85);
});
```

After creating the test, run it to confirm RED state (tests fail because ExamResult class doesn't exist yet):
```bash
php artisan test --compact --filter=ExamResultTest
```

The tests MUST fail. If they pass, something is wrong (class already exists from a different phase).
  </action>
  <verify>
    <automated>php artisan test --compact --filter=ExamResultTest 2>&1 | grep -E "FAIL|ERROR|Tests:"</automated>
  </verify>
  <done>ExamResultTest.php exists in tests/Unit/ValueObjects/ with 6 test cases covering all boundaries. Tests fail because ExamResult class does not exist yet (RED state confirmed).</done>
</task>

<task type="auto">
  <name>Task 2: GREEN + REFACTOR — Implement ExamResult readonly class and pass all tests</name>
  <files>app/ValueObjects/ExamResult.php</files>
  <action>
Create the `app/ValueObjects/` directory if it doesn't exist, then create the ExamResult class.

The file must have:
- `declare(strict_types=1)`
- `namespace App\ValueObjects;`
- Imports: `App\Enums\ExamLevel`, `App\Enums\SubjectName`, `App\Exceptions\FailedExamException`

```php
readonly class ExamResult
{
    public function __construct(
        public SubjectName $subject,
        public ExamLevel $level,
        public int $percentage,
    ) {
        // CRITICAL: Range check FIRST — this must throw InvalidArgumentException for -1, 101
        if ($percentage < 0 || $percentage > 100) {
            throw new \InvalidArgumentException(
                "Percentage must be between 0 and 100, got {$percentage}.",
            );
        }

        // Business rule SECOND — this must throw FailedExamException for 0, 1, 19
        if ($percentage < 20) {
            throw new FailedExamException($subject, $percentage);
        }
    }

    public function points(): int
    {
        return $this->percentage;
    }

    public function isAdvancedLevel(): bool
    {
        return $this->level === ExamLevel::Advanced;
    }
}
```

After creating the file:

1. Run tests to confirm GREEN:
```bash
php artisan test --compact --filter=ExamResultTest
```
All tests must pass.

2. REFACTOR — Run Pint:
```bash
vendor/bin/pint --dirty --format agent
```

3. Run PHPStan on the VO file:
```bash
./vendor/bin/phpstan analyse app/ValueObjects/ExamResult.php --no-progress
```

Fix any issues from Pint or PHPStan and re-run tests to confirm they still pass.
  </action>
  <verify>
    <automated>php artisan test --compact --filter=ExamResultTest && vendor/bin/pint --dirty --format agent && ./vendor/bin/phpstan analyse app/ValueObjects/ExamResult.php --no-progress</automated>
  </verify>
  <done>ExamResult readonly class exists with two-stage validation (range first, business rule second). All 6 ExamResultTest cases pass. Pint and PHPStan clean.</done>
</task>

</tasks>

<verification>
Run these checks to confirm ExamResult VO and tests are correct:

1. `php artisan test --compact --filter=ExamResultTest` — all tests pass
2. `./vendor/bin/phpstan analyse app/ValueObjects/ExamResult.php --no-progress` — zero errors at level 7
3. `vendor/bin/pint --dirty --format agent` — no formatting changes needed
4. Verify two-stage validation order: the test for -1 must throw InvalidArgumentException (NOT FailedExamException)
</verification>

<success_criteria>
- app/ValueObjects/ExamResult.php exists as a readonly class with SubjectName, ExamLevel, int constructor
- Constructor throws InvalidArgumentException for percentage < 0 or > 100 (range check first)
- Constructor throws FailedExamException for percentage 0-19 (business rule second)
- points() returns the percentage value
- isAdvancedLevel() returns true only for ExamLevel::Advanced
- tests/Unit/ValueObjects/ExamResultTest.php passes with full boundary coverage
- PHPStan level 7 passes with zero errors
- Pint passes with no formatting issues
</success_criteria>

<output>
After completion, create `.planning/phases/02-value-objects/02-01-SUMMARY.md`
</output>
