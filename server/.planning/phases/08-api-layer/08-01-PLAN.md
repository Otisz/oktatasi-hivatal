---
phase: 08-api-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bootstrap/app.php
  - routes/api.php
  - app/Http/Controllers/ApplicantController.php
  - app/Http/Resources/ApplicantResource.php
  - app/Http/Resources/ScoreResource.php
autonomous: true
requirements: [API-01, API-02, API-03, API-04, API-05]

must_haves:
  truths:
    - "GET /api/v1/applicants returns 200 with applicant list wrapped in { data: [...] }"
    - "GET /api/v1/applicants/{uuid}/score returns 200 with { data: { osszpontszam, alappont, tobbletpont } } for valid applicant"
    - "AdmissionException subclasses render as 422 with { error: '<Hungarian message>' }"
    - "Unknown applicant UUID returns 404 via implicit route model binding"
  artifacts:
    - path: "routes/api.php"
      provides: "API route definitions with /v1 prefix group"
      contains: "Route::prefix('v1')"
    - path: "app/Http/Controllers/ApplicantController.php"
      provides: "Controller with index() and score() methods"
      contains: "AdmissionScoringService"
    - path: "app/Http/Resources/ApplicantResource.php"
      provides: "JSON resource for applicant with nested program data"
      contains: "toArray"
    - path: "app/Http/Resources/ScoreResource.php"
      provides: "JSON resource wrapping Score VO with Hungarian keys"
      contains: "osszpontszam"
    - path: "bootstrap/app.php"
      provides: "API route registration and exception rendering"
      contains: "AdmissionException"
  key_links:
    - from: "bootstrap/app.php"
      to: "routes/api.php"
      via: "withRouting(api:) parameter"
      pattern: "api:.*routes/api\\.php"
    - from: "bootstrap/app.php"
      to: "App\\Exceptions\\AdmissionException"
      via: "withExceptions()->render() typed closure"
      pattern: "render.*AdmissionException"
    - from: "app/Http/Controllers/ApplicantController.php"
      to: "App\\Services\\AdmissionScoringService"
      via: "constructor injection"
      pattern: "AdmissionScoringService"
---

<objective>
Wire the API layer: create routes, controller, Eloquent resources, and exception rendering.

Purpose: Connect all existing business logic (AdmissionScoringService, Score VO, AdmissionException hierarchy) to HTTP endpoints. This is pure infrastructure wiring — no business logic is created.

Output: Two live endpoints (applicant list + score calculation), exception rendering for 422 errors, and automatic 404 for missing applicants.
</objective>

<execution_context>
@/Users/otisz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/otisz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From app/Services/AdmissionScoringService.php:
```php
final class AdmissionScoringService
{
    public function __construct(
        private ProgramRegistryInterface $programRegistry,
        private BasePointCalculatorInterface $basePointCalculator,
        private BonusPointCalculatorInterface $bonusPointCalculator,
    ) {}

    public function calculateForApplicant(Applicant $applicant): Score
```

From app/ValueObjects/Score.php:
```php
final readonly class Score
{
    public function __construct(public int $basePoints, public int $bonusPoints) {}
    public function total(): int          // basePoints + bonusPoints
    public function basePoints(): int     // getter
    public function bonusPoints(): int    // getter
}
```

From app/Models/Applicant.php:
```php
final class Applicant extends Model
{
    use HasFactory, HasUuids;
    public const string CASE_1_UUID = '0195a1b2-0000-7000-8000-000000000001';
    public const string CASE_2_UUID = '0195a1b2-0000-7000-8000-000000000002';
    public const string CASE_3_UUID = '0195a1b2-0000-7000-8000-000000000003';
    public const string CASE_4_UUID = '0195a1b2-0000-7000-8000-000000000004';
    public function program(): BelongsTo     // -> Program
    public function examResults(): HasMany   // -> ApplicantExamResult
    public function bonusPoints(): HasMany   // -> ApplicantBonusPoint
}
```

From app/Models/Program.php:
```php
final class Program extends Model
{
    use HasFactory, HasUuids;
    // columns: id, university, faculty, name
    public function subjects(): HasMany  // -> ProgramSubject
}
```

From app/Exceptions/AdmissionException.php:
```php
abstract class AdmissionException extends \Exception {}
```
6 final subclasses: FailedExamException, MissingGlobalMandatorySubjectException, MissingProgramMandatorySubjectException, ProgramMandatorySubjectLevelException, MissingElectiveSubjectException, UnknownProgramException

From app/Http/Controllers/Controller.php:
```php
abstract class Controller {}
```

From bootstrap/app.php (current state):
```php
return Application::configure(basePath: dirname(__DIR__))
    ->withRouting(
        web: __DIR__.'/../routes/web.php',
        commands: __DIR__.'/../routes/console.php',
        health: '/up',
    )
    ->withMiddleware(function (Middleware $middleware): void {})
    ->withExceptions(function (Exceptions $exceptions): void {})->create();
```

From app/Providers/AppServiceProvider.php:
```php
// Already binds ProgramRegistryInterface, BasePointCalculatorInterface, BonusPointCalculatorInterface as singletons
// Model::unguard(), Model::preventLazyLoading(), Model::preventAccessingMissingAttributes() all active
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API routes, controller, and resources</name>
  <files>
    routes/api.php,
    app/Http/Controllers/ApplicantController.php,
    app/Http/Resources/ApplicantResource.php,
    app/Http/Resources/ScoreResource.php
  </files>
  <action>
    Create 4 files. All must have `declare(strict_types=1)` and use `final class` convention.

    **routes/api.php:**
    - Use `Route::prefix('v1')->group(...)` with two routes:
      - `GET /applicants` -> `ApplicantController::class, 'index'`
      - `GET /applicants/{applicant}/score` -> `ApplicantController::class, 'score'`
    - Final URLs: `/api/v1/applicants` and `/api/v1/applicants/{applicant}/score`
    - The `/api` prefix comes automatically from `withRouting(api:)` registration

    **app/Http/Controllers/ApplicantController.php:**
    - Extends `Controller` (the abstract base in app/Http/Controllers/)
    - Constructor injection of `AdmissionScoringService $scoringService`
    - `index()` method: returns `ApplicantResource::collection(Applicant::query()->with('program')->get())`
      - Return type: `AnonymousResourceCollection` (from `Illuminate\Http\Resources\Json`)
      - CRITICAL: must use `->with('program')` because `Model::preventLazyLoading()` is active
    - `score(Applicant $applicant)` method: returns `ScoreResource`
      - FIRST call `$applicant->load('program.subjects', 'examResults', 'bonusPoints')` — route model binding does NOT eager-load, and the scoring service accesses all three relationships
      - Then call `$this->scoringService->calculateForApplicant($applicant)` which returns a `Score` VO
      - Return `new ScoreResource($score)`
      - Implicit route model binding on `{applicant}` automatically 404s for unknown UUIDs — no custom code needed

    **app/Http/Resources/ApplicantResource.php:**
    - Extends `JsonResource`
    - `toArray(Request $request): array` returns:
      ```php
      [
          'id' => $this->id,
          'program' => [
              'university' => $this->program->university,
              'faculty' => $this->program->faculty,
              'name' => $this->program->name,
          ],
      ]
      ```

    **app/Http/Resources/ScoreResource.php:**
    - Extends `JsonResource`
    - Wraps a `Score` VO (not an Eloquent model), so access methods via `$this->resource`
    - `toArray(Request $request): array` returns:
      ```php
      [
          'osszpontszam' => $this->resource->total(),
          'alappont'     => $this->resource->basePoints(),
          'tobbletpont'  => $this->resource->bonusPoints(),
      ]
      ```
    - Use `$this->resource->method()` NOT `$this->method()` — JsonResource proxies property access but not method calls on non-Model resources

    Run `vendor/bin/pint --dirty --format agent` after creating all files.
  </action>
  <verify>
    <automated>vendor/bin/pint --dirty --format agent && php artisan route:list --path=api 2>&1 | grep -c applicant</automated>
  </verify>
  <done>
    - 4 files created with correct structure
    - `php artisan route:list` shows 2 API routes under /api/v1/applicants
    - Pint passes with no changes needed
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire API routes and exception rendering in bootstrap/app.php</name>
  <files>bootstrap/app.php</files>
  <action>
    Modify `bootstrap/app.php` to add two things:

    **1. Register API route file in `withRouting()`:**
    Add `api: __DIR__.'/../routes/api.php',` parameter to the existing `withRouting()` call, after the `web:` line. This gives the `api` middleware group and `/api` URI prefix automatically.

    **2. Wire AdmissionException rendering in `withExceptions()`:**
    Replace the empty `withExceptions` callback body with:
    ```php
    $exceptions->render(function (\App\Exceptions\AdmissionException $e): \Illuminate\Http\JsonResponse {
        return response()->json(['error' => $e->getMessage()], 422);
    });
    ```
    - Type-hint on the abstract `AdmissionException` catches all 6 subclasses
    - Returns `{ "error": "<Hungarian message>" }` with 422 status
    - Use FQCNs inline (consistent with AppServiceProvider pattern in this project)

    **API-05 verification:** ProgramRegistry is already bound as singleton in AppServiceProvider (done in Phase 7). No new binding needed — just confirm it exists by reading the file during execution.

    Run `vendor/bin/pint --dirty --format agent` after modifications.
  </action>
  <verify>
    <automated>php artisan route:list --path=api/v1 2>&1</automated>
  </verify>
  <done>
    - bootstrap/app.php registers `routes/api.php` via `api:` parameter
    - bootstrap/app.php renders AdmissionException as 422 JSON with `{ error: message }`
    - `php artisan route:list` shows both `/api/v1/applicants` and `/api/v1/applicants/{applicant}/score`
    - API-05 confirmed: ProgramRegistryInterface singleton binding exists in AppServiceProvider
  </done>
</task>

</tasks>

<verification>
1. `php artisan route:list --path=api` shows 2 routes: GET /api/v1/applicants and GET /api/v1/applicants/{applicant}/score
2. `vendor/bin/pint --dirty --format agent` reports no changes
3. All existing tests still pass: `php artisan test --compact`
</verification>

<success_criteria>
- Two API routes registered and visible in route list
- Controller injects AdmissionScoringService and eager-loads all required relationships
- ApplicantResource wraps applicant with nested program data in { data: [...] }
- ScoreResource maps Score VO to Hungarian keys in { data: { osszpontszam, alappont, tobbletpont } }
- AdmissionException renders as 422 { error: "<message>" } via bootstrap/app.php
- Implicit route model binding on UUID provides automatic 404
</success_criteria>

<output>
After completion, create `.planning/phases/08-api-layer/08-01-SUMMARY.md`
</output>
