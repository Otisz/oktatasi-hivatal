---
phase: 03-database-schema-and-models
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/Enums/RequirementType.php
  - database/migrations/2026_02_25_000001_create_programs_table.php
  - database/migrations/2026_02_25_000002_create_program_subjects_table.php
  - database/migrations/2026_02_25_000003_create_applicants_table.php
  - database/migrations/2026_02_25_000004_create_applicant_exam_results_table.php
  - database/migrations/2026_02_25_000005_create_applicant_bonus_points_table.php
autonomous: true
requirements:
  - DB-01
  - DB-02
  - DB-03
  - DB-04
  - DB-05

must_haves:
  truths:
    - "RequirementType enum has Mandatory ('mandatory') and Elective ('elective') backed string cases"
    - "php artisan migrate:fresh runs without error and creates all five domain tables plus the three default Laravel tables"
    - "programs table has uuid PK, string university, string faculty, string name, and timestamps"
    - "program_subjects table has uuid PK, foreignUuid program_id with cascade delete, string subject_name, string requirement_type, nullable string required_level, and timestamps"
    - "applicants table has uuid PK, foreignUuid program_id with cascade delete, and timestamps"
    - "applicant_exam_results table has uuid PK, foreignUuid applicant_id with cascade delete, string subject_name, string level, unsignedTinyInteger percentage, and timestamps"
    - "applicant_bonus_points table has uuid PK, foreignUuid applicant_id with cascade delete, string category, string type, nullable string language, and timestamps"
  artifacts:
    - path: "app/Enums/RequirementType.php"
      provides: "Backed string enum for programme subject requirement types"
      contains: "enum RequirementType: string"
    - path: "database/migrations/2026_02_25_000001_create_programs_table.php"
      provides: "Programs table migration with UUID PK"
      contains: "Schema::create('programs'"
    - path: "database/migrations/2026_02_25_000002_create_program_subjects_table.php"
      provides: "ProgramSubjects table migration with UUID PK and program FK"
      contains: "Schema::create('program_subjects'"
    - path: "database/migrations/2026_02_25_000003_create_applicants_table.php"
      provides: "Applicants table migration with UUID PK and program FK"
      contains: "Schema::create('applicants'"
    - path: "database/migrations/2026_02_25_000004_create_applicant_exam_results_table.php"
      provides: "ApplicantExamResults table migration with UUID PK and applicant FK"
      contains: "Schema::create('applicant_exam_results'"
    - path: "database/migrations/2026_02_25_000005_create_applicant_bonus_points_table.php"
      provides: "ApplicantBonusPoints table migration with UUID PK and applicant FK"
      contains: "Schema::create('applicant_bonus_points'"
  key_links:
    - from: "database/migrations/2026_02_25_000002_create_program_subjects_table.php"
      to: "database/migrations/2026_02_25_000001_create_programs_table.php"
      via: "foreignUuid('program_id')->constrained()->cascadeOnDelete()"
      pattern: "foreignUuid.*program_id.*constrained"
    - from: "database/migrations/2026_02_25_000003_create_applicants_table.php"
      to: "database/migrations/2026_02_25_000001_create_programs_table.php"
      via: "foreignUuid('program_id')->constrained()->cascadeOnDelete()"
      pattern: "foreignUuid.*program_id.*constrained"
    - from: "database/migrations/2026_02_25_000004_create_applicant_exam_results_table.php"
      to: "database/migrations/2026_02_25_000003_create_applicants_table.php"
      via: "foreignUuid('applicant_id')->constrained()->cascadeOnDelete()"
      pattern: "foreignUuid.*applicant_id.*constrained"
---

<objective>
Create the RequirementType enum and all five database migrations that define the admission scoring schema.

Purpose: The database schema is the persistence foundation for all subsequent phases — models (Plan 02), seeders (Phase 4), and business logic (Phase 5+) depend on these tables existing with the correct column types and foreign keys.
Output: One new PHP enum file and five migration files that create the programs, program_subjects, applicants, applicant_exam_results, and applicant_bonus_points tables with UUID primary keys and proper foreign key constraints.
</objective>

<execution_context>
@/Users/otisz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/otisz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-database-schema-and-models/03-CONTEXT.md
@.planning/phases/03-database-schema-and-models/03-RESEARCH.md
@IMPLEMENTATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RequirementType enum and five database migrations</name>
  <files>app/Enums/RequirementType.php, database/migrations/2026_02_25_000001_create_programs_table.php, database/migrations/2026_02_25_000002_create_program_subjects_table.php, database/migrations/2026_02_25_000003_create_applicants_table.php, database/migrations/2026_02_25_000004_create_applicant_exam_results_table.php, database/migrations/2026_02_25_000005_create_applicant_bonus_points_table.php</files>
  <action>
**Step 1: Create RequirementType enum**

Run `php artisan make:enum RequirementType --string --no-interaction` to scaffold, then replace its content with:

```php
<?php

declare(strict_types=1);

namespace App\Enums;

enum RequirementType: string
{
    case Mandatory = 'mandatory';
    case Elective = 'elective';
}
```

This enum is used by the ProgramSubject model (Plan 02) and the DatabaseProgramRequirements service (Phase 5) to distinguish mandatory vs elective subjects.

**Step 2: Create all five migrations in dependency order**

Run these artisan commands to scaffold the migration files:
```bash
php artisan make:migration create_programs_table --no-interaction
php artisan make:migration create_program_subjects_table --no-interaction
php artisan make:migration create_applicants_table --no-interaction
php artisan make:migration create_applicant_exam_results_table --no-interaction
php artisan make:migration create_applicant_bonus_points_table --no-interaction
```

Then replace the content of each migration file with the exact schema below. Every migration must include `declare(strict_types=1);` after the `<?php` tag.

**CRITICAL: All tables use `$table->uuid('id')->primary()` — NOT `$table->id()`. This is locked in CONTEXT.md and must not be deviated from.**

**Migration 1: create_programs_table**
```php
<?php

declare(strict_types=1);

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('programs', function (Blueprint $table): void {
            $table->uuid('id')->primary();
            $table->string('university');
            $table->string('faculty');
            $table->string('name');
            $table->timestamps();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('programs');
    }
};
```

**Migration 2: create_program_subjects_table**
```php
<?php

declare(strict_types=1);

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('program_subjects', function (Blueprint $table): void {
            $table->uuid('id')->primary();
            $table->foreignUuid('program_id')->constrained()->cascadeOnDelete();
            $table->string('subject_name');
            $table->string('requirement_type');
            $table->string('required_level')->nullable();
            $table->timestamps();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('program_subjects');
    }
};
```

**Migration 3: create_applicants_table**
```php
<?php

declare(strict_types=1);

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('applicants', function (Blueprint $table): void {
            $table->uuid('id')->primary();
            $table->foreignUuid('program_id')->constrained()->cascadeOnDelete();
            $table->timestamps();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('applicants');
    }
};
```

**Migration 4: create_applicant_exam_results_table**
```php
<?php

declare(strict_types=1);

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('applicant_exam_results', function (Blueprint $table): void {
            $table->uuid('id')->primary();
            $table->foreignUuid('applicant_id')->constrained()->cascadeOnDelete();
            $table->string('subject_name');
            $table->string('level');
            $table->unsignedTinyInteger('percentage');
            $table->timestamps();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('applicant_exam_results');
    }
};
```

**Migration 5: create_applicant_bonus_points_table**
```php
<?php

declare(strict_types=1);

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('applicant_bonus_points', function (Blueprint $table): void {
            $table->uuid('id')->primary();
            $table->foreignUuid('applicant_id')->constrained()->cascadeOnDelete();
            $table->string('category');
            $table->string('type');
            $table->string('language')->nullable();
            $table->timestamps();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('applicant_bonus_points');
    }
};
```

IMPORTANT notes:
- The `void` return type on the closure parameter (`function (Blueprint $table): void`) is required by Pint's `void_return` rule.
- Migration file names will have timestamps from `make:migration`. The filenames in `files_modified` are illustrative — use whatever artisan generates.
- Foreign keys use `->constrained()->cascadeOnDelete()` per 03-RESEARCH.md locked decisions.
- The `percentage` column uses `unsignedTinyInteger` per CONTEXT.md locked decisions.
- The `language` column on applicant_bonus_points is nullable per IMPLEMENTATION.md Section 2.
- The `required_level` column on program_subjects is nullable per IMPLEMENTATION.md Section 2.

After creating all files, run:
```bash
vendor/bin/pint --dirty --format agent
./vendor/bin/phpstan analyse app/Enums/RequirementType.php --no-progress
php artisan migrate:fresh --no-interaction
```
  </action>
  <verify>
    <automated>vendor/bin/pint --dirty --format agent && ./vendor/bin/phpstan analyse app/Enums/RequirementType.php --no-progress && php artisan migrate:fresh --no-interaction</automated>
  </verify>
  <done>RequirementType enum exists with Mandatory/Elective cases. All five migrations run successfully via migrate:fresh. Tables have correct UUID PKs, foreign keys with cascade delete, correct column types (unsignedTinyInteger for percentage, nullable strings for required_level and language), and timestamps. Pint and PHPStan pass.</done>
</task>

<task type="auto">
  <name>Task 2: Verify database schema matches specification</name>
  <files>None (verification only)</files>
  <action>
After migrate:fresh succeeds, verify the created schema matches the specification exactly. Use the `database-schema` tool (or `php artisan tinker` / `database-query` tool) to confirm:

1. **programs table:** id (uuid PK), university (string), faculty (string), name (string), created_at, updated_at
2. **program_subjects table:** id (uuid PK), program_id (uuid FK → programs), subject_name (string), requirement_type (string), required_level (string, nullable), created_at, updated_at
3. **applicants table:** id (uuid PK), program_id (uuid FK → programs), created_at, updated_at
4. **applicant_exam_results table:** id (uuid PK), applicant_id (uuid FK → applicants), subject_name (string), level (string), percentage (unsigned tinyint), created_at, updated_at
5. **applicant_bonus_points table:** id (uuid PK), applicant_id (uuid FK → applicants), category (string), type (string), language (string, nullable), created_at, updated_at

Run the `database-schema` tool with `include_column_details: true` to verify nullable columns and column types. If any column is wrong, fix the migration and re-run `migrate:fresh`.

Also verify foreign key constraints exist:
- program_subjects.program_id → programs.id
- applicants.program_id → programs.id
- applicant_exam_results.applicant_id → applicants.id
- applicant_bonus_points.applicant_id → applicants.id
  </action>
  <verify>
    <automated>php artisan migrate:fresh --no-interaction 2>&1 | tail -1</automated>
  </verify>
  <done>All five tables exist with correct column types, nullability, UUID primary keys, and foreign key constraints pointing to the correct parent tables. Schema matches IMPLEMENTATION.md Section 2 and CONTEXT.md locked decisions exactly.</done>
</task>

</tasks>

<verification>
Run these checks to confirm the schema is correct:

1. `php artisan migrate:fresh --no-interaction` — completes without error
2. `vendor/bin/pint --dirty --format agent` — no formatting issues on enum or migration files
3. `./vendor/bin/phpstan analyse app/Enums/RequirementType.php --no-progress` — zero errors
4. Use `database-schema` tool with `include_column_details: true` to verify all five tables match the spec
5. Quick tinker check: `App\Enums\RequirementType::Mandatory->value` returns `'mandatory'` and `App\Enums\RequirementType::Elective->value` returns `'elective'`
</verification>

<success_criteria>
- RequirementType.php exists with Mandatory ('mandatory') and Elective ('elective') backed string cases
- Five migration files exist and run without error
- All tables use uuid('id')->primary() as PK (not bigIncrements)
- Foreign keys use foreignUuid with constrained()->cascadeOnDelete()
- percentage column is unsignedTinyInteger
- required_level and language columns are nullable strings
- All other string columns are string(255) default
- All tables have timestamps
- PHPStan passes on the enum file
- Pint passes on all new files
</success_criteria>

<output>
After completion, create `.planning/phases/03-database-schema-and-models/03-01-SUMMARY.md`
</output>
