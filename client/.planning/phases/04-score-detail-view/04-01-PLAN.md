---
phase: 04-score-detail-view
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/views/ApplicantDetailView.vue]
autonomous: false
requirements: [SCORE-01, SCORE-02, SCORE-03, SCORE-04]

must_haves:
  truths:
    - "Visiting /applicants/:id for a scorable applicant displays the total score (osszpontszam) prominently above the base points (alappont) and bonus points (tobbletpont) breakdown"
    - "A loading skeleton with hero number area and two breakdown card placeholders is visible while the score is being fetched"
    - "When the API returns a 422, a styled amber error card displays 'Pontozas nem lehetsege' heading and the verbatim Hungarian error message from the API"
    - "When a generic (non-422) error occurs, a gray error state with a 'Probaja ujra' retry button is displayed"
    - "A back link ('Vissza') is always visible above all states (loading, success, domain error, generic error)"
    - "Programme info (university, faculty, programme name) is shown above the score area when navigating from the applicant list"
  artifacts:
    - path: "src/views/ApplicantDetailView.vue"
      provides: "Score detail view with loading skeleton, hero score, breakdown cards, domain error card, generic error with retry, and back navigation"
      min_lines: 80
  key_links:
    - from: "src/views/ApplicantDetailView.vue"
      to: "src/composables/useApplicantScore.ts"
      via: "useApplicantScore() composable import"
      pattern: "useApplicantScore"
    - from: "src/views/ApplicantDetailView.vue"
      to: "src/types/api.ts"
      via: "Applicant type for cache lookup"
      pattern: "Applicant"
    - from: "src/views/ApplicantDetailView.vue"
      to: "@tanstack/vue-query"
      via: "useQueryClient for reading applicants cache"
      pattern: "useQueryClient"
---

<objective>
Implement the score detail view — the final view completing the end-to-end user flow from applicant list to score breakdown.

Purpose: Users need to see an applicant's full score breakdown (total, base, bonus) or a clear Hungarian error message explaining why the score cannot be calculated, and navigate back to the list.
Output: Fully functional `src/views/ApplicantDetailView.vue` replacing the current placeholder.
</objective>

<execution_context>
@/Users/otisz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/otisz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-score-detail-view/04-CONTEXT.md
@.planning/phases/04-score-detail-view/04-RESEARCH.md

@src/views/ApplicantDetailView.vue
@src/composables/useApplicantScore.ts
@src/composables/useApplicants.ts
@src/types/api.ts
@src/views/ApplicantsView.vue
@src/App.vue

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/types/api.ts:
```typescript
export interface Program {
  university: string
  faculty: string
  name: string
}

export interface Applicant {
  id: string
  program: Program
}

export interface ScoreResult {
  osszpontszam: number
  alappont: number
  tobbletpont: number
}

export interface ApiError {
  error: string
}
```

From src/composables/useApplicantScore.ts:
```typescript
// Discriminated union for error types
export type ScoreError = { kind: 'domain'; message: string } | { kind: 'generic' }

// Returns UseQueryReturnType<ScoreResult, ScoreError>
// Destructure: { isLoading, isError, error, data, refetch }
// isLoading = isPending && isFetching (true only on first fetch with no cache)
// error is Ref<ScoreError | null>
// data is Ref<ScoreResult | undefined>
// refetch() triggers a manual re-fetch (bypasses retry config)
export function useApplicantScore(id: MaybeRefOrGetter<string>): UseQueryReturnType<ScoreResult, ScoreError>
```

From src/composables/useApplicants.ts:
```typescript
// Returns UseQueryReturnType<Applicant[], Error>
// Query key: ['applicants']
// Cache has 30-min staleTime — warm after list view visit
export function useApplicants(): UseQueryReturnType<Applicant[], Error>
```

From @tanstack/vue-query:
```typescript
// useQueryClient().getQueryData<T>(queryKey) returns T | undefined
// Synchronous cache read — no network call triggered
```

From src/router/index.ts:
```typescript
// Route: { path: '/applicants/:id', name: 'applicant-detail', component: ApplicantDetailView }
// route.params.id is string | string[] — use getter with `as string` cast
```

Established patterns from App.vue and ApplicantsView.vue:
```html
<!-- Container: -->
<div class="max-w-4xl mx-auto px-4 py-6">

<!-- Card surfaces: -->
<div class="bg-white border border-gray-200 rounded-lg p-4">

<!-- Skeleton loading: -->
<div class="animate-pulse">
  <div class="h-N bg-gray-200 rounded w-XX"></div>
</div>

<!-- Error icon pattern (from ApplicantsView): -->
<svg class="h-12 w-12 text-gray-300 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
</svg>

<!-- Color scheme: bg-gray-50 page, bg-white surfaces, border-gray-200 borders -->
<!-- text-gray-900 primary, text-gray-500 secondary, text-blue-600 links -->
<!-- All UI text in Hungarian -->
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement ApplicantDetailView.vue with score breakdown and error states</name>
  <files>src/views/ApplicantDetailView.vue</files>
  <action>
Replace the entire content of `src/views/ApplicantDetailView.vue` with the full score detail implementation.

**Script setup:**
- Import `computed` from `vue`
- Import `RouterLink`, `useRoute` from `vue-router`
- Import `useQueryClient` from `@tanstack/vue-query`
- Import `useApplicantScore` from `@/composables/useApplicantScore`
- Import `type Applicant` from `@/types/api`
- Get route: `const route = useRoute()`
- Get query client: `const queryClient = useQueryClient()`
- Read programme info from cache (synchronous, no network call):
  ```typescript
  const applicant = computed(() => {
    const cached = queryClient.getQueryData<Applicant[]>(['applicants'])
    return cached?.find(a => a.id === (route.params.id as string))
  })
  ```
- Destructure score query: `const { isLoading, isError, error, data, refetch } = useApplicantScore(() => route.params.id as string)`
  - Pass a getter function `() => route.params.id as string` (NOT `route.params.id` directly — it's `string | string[]`, and a getter preserves reactivity)
  - Use `isLoading` (NOT `isPending`) — same reasoning as Phase 3: avoids skeleton flash on back-navigation with cached data

**Template structure — outer container `<div class="max-w-4xl mx-auto px-4 py-6">`:**

**Always-visible back link (above ALL states):**
```html
<RouterLink to="/applicants" class="text-sm text-blue-600 hover:underline mb-4 inline-block">
  &larr; Vissza
</RouterLink>
```

**Programme context header (always visible when cache is warm):**
- `<div v-if="applicant" class="mb-6">`
  - `<p class="text-xs text-gray-500">{{ applicant.program.university }} — {{ applicant.program.faculty }}</p>` (use em dash `—`, matching ApplicantsView pattern)
  - `<h2 class="text-lg font-semibold text-gray-900 mt-0.5">{{ applicant.program.name }}</h2>`
- `<h2 v-else class="text-lg font-semibold text-gray-900 mb-6">Pontozas</h2>` (cold cache fallback — direct URL load)
  - Note: Use the proper Hungarian character: `Pontozás` (with accent)

**Four mutually exclusive score content branches using v-if/v-else-if/v-else:**

**CRITICAL: The domain error branch MUST come BEFORE the generic error branch.** If reversed, `v-else-if="isError"` would catch all errors first, and the amber card would never render.

**Branch 1: Loading skeleton** (`v-if="isLoading"`)
- Wrapper: `<div class="animate-pulse">`
- Hero score placeholder:
  ```html
  <div class="bg-white border border-gray-200 rounded-lg p-8 mb-4 flex flex-col items-center">
    <div class="h-4 bg-gray-200 rounded w-32 mb-4"></div>
    <div class="h-16 bg-gray-200 rounded w-24"></div>
  </div>
  ```
- Two breakdown card placeholders side by side:
  ```html
  <div class="grid grid-cols-2 gap-4">
    <div class="bg-white border border-gray-200 rounded-lg p-4">
      <div class="h-3 bg-gray-200 rounded w-20 mb-2"></div>
      <div class="h-8 bg-gray-200 rounded w-16"></div>
    </div>
    <div class="bg-white border border-gray-200 rounded-lg p-4">
      <div class="h-3 bg-gray-200 rounded w-20 mb-2"></div>
      <div class="h-8 bg-gray-200 rounded w-16"></div>
    </div>
  </div>
  ```

**Branch 2: 422 domain error — amber card** (`v-else-if="isError && error?.kind === 'domain'"`)
- `<div class="bg-amber-50 border border-amber-200 rounded-lg p-6">`
- `<h3 class="text-base font-semibold text-amber-900 mb-2">Pontozás nem lehetséges</h3>`
- `<p class="text-sm text-amber-800">{{ error.message }}</p>` — display the verbatim Hungarian error message from the API. Do NOT translate, strip, or reformat.

**Branch 3: Generic error with retry** (`v-else-if="isError"`)
- `<div class="text-center py-12">`
- Reuse the same exclamation-triangle SVG icon from ApplicantsView:
  ```html
  <svg class="h-12 w-12 text-gray-300 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
  </svg>
  ```
- `<p class="text-lg font-medium text-gray-900 mt-4">Hiba történt</p>`
- `<p class="text-sm text-gray-500 mt-1">A pontozás betöltése sikertelen. Kérjük, próbálja újra.</p>`
- Retry button: `<button class="mt-4 text-sm text-blue-600 hover:underline" @click="refetch()">Próbálja újra</button>`
  - `refetch()` is a manual user-initiated retry from TanStack Query — it bypasses the `retry` config which suppresses automatic retries for domain errors

**Branch 4: Score breakdown — success state** (`v-else-if="data"`)
- Hero score card (total — prominent focal point):
  ```html
  <div class="bg-white border border-gray-200 rounded-lg p-8 mb-4 text-center">
    <p class="text-sm text-gray-500 mb-2">Összpontszám</p>
    <p class="text-5xl font-bold text-gray-900">{{ data.osszpontszam }}</p>
  </div>
  ```
- Two breakdown cards side by side:
  ```html
  <div class="grid grid-cols-2 gap-4">
    <div class="bg-white border border-gray-200 rounded-lg p-4 text-center">
      <p class="text-xs text-gray-500 mb-1">Alappont</p>
      <p class="text-2xl font-semibold text-gray-900">{{ data.alappont }}</p>
    </div>
    <div class="bg-white border border-gray-200 rounded-lg p-4 text-center">
      <p class="text-xs text-gray-500 mb-1">Többletpont</p>
      <p class="text-2xl font-semibold text-gray-900">{{ data.tobbletpont }}</p>
    </div>
  </div>
  ```

**No `<style>` block needed** — all styling via Tailwind utility classes.

**Biome compliance:** Run `npx biome check src/views/ApplicantDetailView.vue` after writing. Fix any formatting issues. The project uses Biome 2.x with default Vue SFC support.
  </action>
  <verify>
    <automated>cd /Users/otisz/Projects/oktatasi-hivatal/client && npx biome check src/views/ApplicantDetailView.vue && npx vue-tsc --noEmit</automated>
  </verify>
  <done>
- ApplicantDetailView.vue has four rendering branches: loading skeleton, domain error (amber), generic error (with retry), score breakdown
- Back link ("Vissza") is always visible above all states
- Programme info from TanStack Query cache displayed when navigating from list; fallback "Pontozas" heading on cold cache
- Loading skeleton mirrors hero + two-card layout with animate-pulse
- Domain error branch (isError && error?.kind === 'domain') comes BEFORE generic error branch
- Amber card shows "Pontozas nem lehetsege" heading and verbatim error.message
- Generic error reuses ApplicantsView icon pattern with "Probaja ujra" retry button calling refetch()
- Hero score shows osszpontszam in text-5xl font-bold
- Breakdown cards show alappont and tobbletpont side by side in grid-cols-2
- All labels in Hungarian: "Osszpontszam", "Alappont", "Tobbletpont"
- Biome check passes with no violations
- TypeScript compilation passes with no errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify score detail view in browser</name>
  <files>src/views/ApplicantDetailView.vue</files>
  <action>
Human visual and functional verification of the score detail view.

What was built:
- Complete score detail view at `/applicants/:id` with hero score, breakdown cards, domain error card, generic error with retry, and loading skeleton
- Programme context header sourced from TanStack Query cache
- Back navigation link always visible
- All text in Hungarian

How to verify:
1. Start the dev server: `npm run dev`
2. Open browser to `http://localhost:5173/applicants`
3. Click any applicant card to navigate to their score detail view
4. **Programme context:** Verify university, faculty, and programme name appear above the score area (sourced from the list cache)
5. **Back link:** Verify "Vissza" link is visible at the top; click it to return to the list; click back into a detail view
6. **Score breakdown (scorable applicant):**
   - Large total score number ("Osszpontszam" label) prominently displayed in a centered card
   - "Alappont" and "Tobbletpont" shown as two side-by-side cards below the hero
   - Numbers match the API response values
7. **Loading skeleton:** Hard-refresh (Cmd+Shift+R) on the detail page — briefly observe the pulsing skeleton (hero rectangle + two breakdown rectangles) before data loads
8. **422 domain error:** Navigate to an applicant that returns a 422 — verify an amber/warning card appears with "Pontozas nem lehetsege" heading and the Hungarian error message from the API (not a generic message)
9. **Back navigation from error:** Verify the "Vissza" back link is visible even on error states
10. **Responsive:** Resize browser to mobile width (~375px) — cards should remain readable, two breakdown cards may stack or remain side by side but no horizontal scroll
11. **Cached back-navigation:** After viewing a score, click "Vissza" to go back to the list, then click the same applicant again — score should appear immediately without a skeleton flash (cached data)

Resume signal: Type "approved" or describe any visual/functional issues.
  </action>
  <verify>Human confirms visual and functional correctness in the browser</verify>
  <done>User has approved the score detail view — all rendering states, navigation, error display, and responsive layout confirmed working</done>
</task>

</tasks>

<verification>
- `npx biome check src/views/ApplicantDetailView.vue` passes (lint + format)
- `npx vue-tsc --noEmit` passes (TypeScript)
- ApplicantDetailView.vue imports `useApplicantScore` and destructures `isLoading`, `isError`, `error`, `data`, `refetch`
- ApplicantDetailView.vue imports `useQueryClient` from `@tanstack/vue-query` and reads `['applicants']` cache
- Template has the back link OUTSIDE the conditional branches (always visible)
- Template has exactly 4 score content branches: `v-if="isLoading"`, `v-else-if="isError && error?.kind === 'domain'"`, `v-else-if="isError"`, `v-else-if="data"`
- Domain error branch comes BEFORE generic error branch
- Amber card uses `bg-amber-50 border-amber-200` classes (complete static strings for Tailwind scanner)
- Generic error has a `<button>` calling `refetch()`
- Hero score uses `text-5xl font-bold` for the number
- Breakdown cards use `grid grid-cols-2 gap-4` for side-by-side layout
- All UI text is in Hungarian
- Score field names match API exactly: `osszpontszam`, `alappont`, `tobbletpont`
- Label text uses proper Hungarian with accents: "Osszpontszam", "Alappont", "Tobbletpont"
</verification>

<success_criteria>
1. Visiting `/applicants/:id` for a scorable applicant displays the total score (`osszpontszam`) prominently above the base points (`alappont`) and bonus points (`tobbletpont`) breakdown
2. A loading indicator is visible while the score is being fetched before the breakdown or error appears
3. When the API returns a 422, the verbatim Hungarian error message is displayed in a styled error card (not a generic "something went wrong" message)
4. A back navigation link on the detail view returns the user to `/applicants`
</success_criteria>

<output>
After completion, create `.planning/phases/04-score-detail-view/04-01-SUMMARY.md`
</output>
